#!/bin/bash

#==========================================
# Game Launcher - Proton-GE Direct
# Version: 1.0
#==========================================

#------------------------------------------
# Configuration
#------------------------------------------
GAME_NAME="Game Name"
GAME_DIR="$HOME/Games/game-folder"
GAME_EXE="$GAME_DIR/game.exe"
WINE_PREFIX="$GAME_DIR/prefix"
LOG_FILE="$GAME_DIR/game.log"

PROTON_PATH="$HOME/.local/share/Steam/compatibilitytools.d/Proton-GE Latest"
STEAM_APP_ID="0"
GAME_ARGS=""

#------------------------------------------
# Colors
#------------------------------------------
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

#------------------------------------------
# Logging Functions
#------------------------------------------
log() {
    echo -e "${GREEN}[$(date '+%H:%M:%S')]${NC} $1"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
    echo "[ERROR] $1" >> "$LOG_FILE"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
    echo "[WARN] $1" >> "$LOG_FILE"
}

info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

#------------------------------------------
# Cleanup Function
#------------------------------------------
cleanup() {
    local EXIT_CODE=$?
    
    echo ""
    log "Shutdown signal received. Cleaning up..."
    
    # Graceful Wine shutdown
    if [ -n "$WINE_PREFIX" ] && [ -d "$PROTON_PATH" ]; then
        log "Attempting graceful Wine shutdown..."
        WINEPREFIX="$WINE_PREFIX" "$PROTON_PATH/files/bin/wineserver" -k 2>/dev/null
        sleep 2
    fi
    
    # Force kill processes
    log "Terminating processes..."
    
    pkill -9 -f "$(basename "$GAME_EXE")" 2>/dev/null && log "Game process killed"
    pkill -9 -f "wine" 2>/dev/null
    pkill -9 -f "wineserver" 2>/dev/null
    pkill -9 -f "winedevice.exe" 2>/dev/null
    pkill -9 -f "services.exe" 2>/dev/null
    pkill -9 -f "gamemoderun" 2>/dev/null
    
    # Final wineserver check
    if [ -n "$WINE_PREFIX" ] && [ -d "$PROTON_PATH" ]; then
        WINEPREFIX="$WINE_PREFIX" "$PROTON_PATH/files/bin/wineserver" -k9 2>/dev/null
    fi
    
    log "Cleanup complete. Exit code: $EXIT_CODE"
    exit $EXIT_CODE
}

#------------------------------------------
# Signal Traps
#------------------------------------------
trap cleanup SIGINT SIGTERM SIGHUP EXIT

#------------------------------------------
# Validation
#------------------------------------------
validate() {
    log "Validating environment..."
    
    # Check Proton
    if [ ! -d "$PROTON_PATH" ]; then
        error "Proton not found at: $PROTON_PATH"
        error "Please update PROTON_PATH variable"
        exit 1
    fi
    
    # Check game executable
    if [ ! -f "$GAME_EXE" ]; then
        error "Game executable not found: $GAME_EXE"
        exit 1
    fi
    
    # Create directories
    mkdir -p "$WINE_PREFIX" "$(dirname "$LOG_FILE")" 2>/dev/null
    
    # Check gamemoderun
    if command -v gamemoderun &> /dev/null; then
        info "GameMode detected and will be used"
        USE_GAMEMODE=true
    else
        warn "GameMode not found, launching without it"
        USE_GAMEMODE=false
    fi
    
    log "Validation complete"
}

#------------------------------------------
# Environment Setup
#------------------------------------------
setup_environment() {
    log "Setting up environment..."
    
    # Proton environment
    export STEAM_COMPAT_DATA_PATH="$WINE_PREFIX"
    export STEAM_COMPAT_CLIENT_INSTALL_PATH="$HOME/.local/share/Steam"
    export STEAM_COMPAT_APP_ID="$STEAM_APP_ID"
    export WINEPREFIX="$WINE_PREFIX"
    
    # Proton settings
    export PROTON_ENABLE_WAYLAND=1
    export PROTON_NO_ESYNC=0
    export PROTON_NO_FSYNC=0
    export PROTON_FORCE_LARGE_ADDRESS_AWARE=1 # for 32-bit games
    export PROTON_USE_STEAM_STUB=0
    
    # DXVK/VKD3D
    # export DXVK_ASYNC=1
    # export DXVK_STATE_CACHE_PATH="$WINE_PREFIX"
    # export DXVK_LOG_PATH="$WINE_PREFIX"
    # export VKD3D_CONFIG=dxr11,dxr
    # export VKD3D_SHADER_CACHE_PATH="$WINE_PREFIX"
    
    # GPU optimizations
    # export __GL_SHADER_DISK_CACHE=1
    # export __GL_SHADER_DISK_CACHE_PATH="$WINE_PREFIX/shader_cache"
    # export RADV_PERFTEST=gpl
    # export mesa_glthread=true
    
    # Performance monitoring
    export MANGOHUD=1
    # export MANGOHUD_CONFIG="cpu_temp,gpu_temp,ram,vram,fps,frametime"
    
    # Disable debug output
    # export WINEDEBUG=-all
    # export DXVK_LOG_LEVEL=none
    
    log "Environment configured"
}

#------------------------------------------
# Launch Game
#------------------------------------------
launch_game() {
    log "=========================================="
    log "  Launching: $GAME_NAME"
    log "=========================================="
    log "Executable: $GAME_EXE"
    log "Wine Prefix: $WINE_PREFIX"
    log "Proton: $(basename "$PROTON_PATH")"
    log "Steam App ID: $STEAM_APP_ID"
    log "=========================================="
    
    # Launch command
    if [ "$USE_GAMEMODE" = true ]; then
        log "Launching with GameMode..."
        gamemoderun "$PROTON_PATH/proton" run "$GAME_EXE" $GAME_ARGS 2>&1 | tee -a "$LOG_FILE"
    else
        log "Launching without GameMode..."
        "$PROTON_PATH/proton" run "$GAME_EXE" $GAME_ARGS 2>&1 | tee -a "$LOG_FILE"
    fi
    
    GAME_EXIT_CODE=$?
    log "Game exited with code: $GAME_EXIT_CODE"
    
    return $GAME_EXIT_CODE
}

#------------------------------------------
# Main Execution
#------------------------------------------
main() {
    clear
    
    echo "=========================================="
    echo "  $GAME_NAME"
    echo "  Proton-GE Launcher v1.0"
    echo "=========================================="
    echo ""
    
    validate
    setup_environment
    launch_game
    
    # Cleanup runs automatically via trap
}

# Run main function
main "$@"
