#!/bin/bash

declare -A DNS=(
	["Shelter First"]="78.157.34.245,2.189.86.41"
	["Shelter Second"]="78.157.48.82,2.189.86.11"
	["SteamDL"]="88.218.16.122,88.218.16.123"
)

DOMAINS=(
	"epicgames.com"
	"store.steampowered.com"
	"ea.com"
	"callofduty.com"
)

query_dns() {
	local name="$1" ips="$2"
	IFS=',' read -ra IP_ARRAY <<<"$ips"

	for ip in "${IP_ARRAY[@]}"; do
		ip=$(echo "$ip" | xargs) # Trim whitespace
		echo -e "\n═══ $name: ($ip) ═══"
		parallel -j4 --keep-order --tag "dig +short @$ip {} A | head -1" ::: "${DOMAINS[@]}" | column -t -s $'\t'
	done
}

main() {
	if ! command -v parallel &>/dev/null; then
		echo "Install GNU Parallel: sudo pacman -S parallel" && exit 1
	fi

	echo "DNS Resolver - Testing ${#DOMAINS[@]} domains on ${#DNS[@]} server groups"

	read -p "Query [a]ll or [s]ingle DNS group? (a/s): " choice

	if [[ $choice == "a" ]]; then
		for name in "${!DNS[@]}"; do
			query_dns "$name" "${DNS[$name]}"
		done
	else
		select name in "${!DNS[@]}"; do
			[[ -n $name ]] && query_dns "$name" "${DNS[$name]}" && break
		done
	fi
}

main
