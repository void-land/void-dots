#!/bin/bash

#==========================================
# UMU Launcher Script
# Version: 1.0
#==========================================

#------------------------------------------
# Configuration - EDIT THIS SECTION
#------------------------------------------
GAME_NAME="My Game"
GAME_DIR="$HOME/Games/game-folder"
GAME_EXE="$GAME_DIR/game.exe"
WINE_PREFIX="$GAME_DIR/umu-prefix"
LOG_FILE="$GAME_DIR/game.log"

# UMU Settings
GAMEID="umu-default"
PROTONPATH="$HOME/.local/share/Steam/compatibilitytools.d/Proton-GE Latest"
STEAM_APP_ID="0"
GAME_ARGS=""

#==========================================
# DO NOT EDIT BELOW THIS LINE
#==========================================

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log() { 
    echo -e "${GREEN}[$(date '+%H:%M:%S')]${NC} $1"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

error() { 
    echo -e "${RED}[ERROR]${NC} $1"
    echo "[ERROR] $1" >> "$LOG_FILE"
}

warn() { 
    echo -e "${YELLOW}[WARN]${NC} $1"
    echo "[WARN] $1" >> "$LOG_FILE"
}

info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

cleanup() {
    local EXIT_CODE=$?
    echo ""
    log "Shutting down..."
    
    # Graceful shutdown
    if [ -n "$WINE_PREFIX" ]; then
        WINEPREFIX="$WINE_PREFIX" wineserver -k 2>/dev/null
        sleep 1
    fi
    
    # Force kill
    pkill -9 -f "$(basename "$GAME_EXE")" 2>/dev/null && log "Game process terminated"
    pkill -9 wine 2>/dev/null
    pkill -9 wineserver 2>/dev/null
    pkill -9 -f pressure-vessel 2>/dev/null
    pkill -9 gamemoderun 2>/dev/null
    
    log "Cleanup complete. Exit code: $EXIT_CODE"
    exit $EXIT_CODE
}

trap cleanup SIGINT SIGTERM SIGHUP EXIT

# Validation
validate() {
    log "Validating environment..."
    
    # Check umu-run
    if ! command -v umu-run &> /dev/null; then
        error "umu-run not found. Install: pacman -S umu-launcher"
        exit 1
    fi
    
    # Check game executable
    if [ ! -f "$GAME_EXE" ]; then
        error "Game executable not found: $GAME_EXE"
        exit 1
    fi
    
    # Create directories
    mkdir -p "$GAME_DIR" "$(dirname "$LOG_FILE")" 2>/dev/null
    
    # Check GameMode
    if command -v gamemoderun &> /dev/null; then
        info "GameMode: Enabled"
        USE_GAMEMODE=true
    else
        warn "GameMode: Not found (install: pacman -S gamemode)"
        USE_GAMEMODE=false
    fi
    
    log "Validation complete"
}

# Environment setup
setup_environment() {
    log "Configuring environment..."
    
    # UMU variables
    export WINEPREFIX="$WINE_PREFIX"
    export GAMEID="$GAMEID"
    export PROTONPATH="$PROTONPATH"
    export STEAM_COMPAT_APP_ID="$STEAM_APP_ID"
    
    # Proton optimizations
    export PROTON_ENABLE_WAYLAND=1
    export PROTON_USE_NTSYNC=1
    export PROTON_NO_ESYNC=0  # Enable ESYNC for better performance
    export PROTON_NO_FSYNC=0  # Enable FSYNC for better performance
    export PROTON_FORCE_LARGE_ADDRESS_AWARE=1
    export PROTON_USE_STEAM_STUB=0
    
    # DXVK/VKD3D
    export DXVK_ASYNC=1
    export DXVK_STATE_CACHE_PATH="$WINE_PREFIX"
    export VKD3D_CONFIG=dxr
    
    # GPU optimizations
    export __GL_SHADER_DISK_CACHE=1
    export __GL_SHADER_DISK_CACHE_PATH="$WINE_PREFIX/shader_cache"
    export RADV_PERFTEST=gpl
    export mesa_glthread=true
    
    # Performance monitoring
    export MANGOHUD=1
    export MANGOHUD_CONFIG="fps,frametime,cpu_temp,gpu_temp"
    
    # Disable debug output
    export WINEDEBUG=-all
    export GST_DEBUG=0
    export DXVK_LOG_LEVEL=none
    
    log "Environment configured"
}

# Launch game
launch_game() {
    log "=========================================="
    log "  Launching: $GAME_NAME"
    log "=========================================="
    log "Executable: $GAME_EXE"
    log "Prefix: $WINE_PREFIX"
    log "Proton: $PROTONPATH"
    log "Game ID: $GAMEID"
    log "Steam App ID: $STEAM_APP_ID"
    log "=========================================="
    
    # Filter warnings
    if [ "$USE_GAMEMODE" = true ]; then
        log "Launching with GameMode..."
        gamemoderun umu-run "$GAME_EXE" $GAME_ARGS 2>&1 | \
        grep -v "GStreamer-WARNING" | \
        grep -v "Failed to load plugin" | \
        grep -v "wrong ELF class" | \
        tee -a "$LOG_FILE"
    else
        log "Launching..."
        umu-run "$GAME_EXE" $GAME_ARGS 2>&1 | \
        grep -v "GStreamer-WARNING" | \
        grep -v "Failed to load plugin" | \
        grep -v "wrong ELF class" | \
        tee -a "$LOG_FILE"
    fi
    
    GAME_EXIT_CODE=$?
    log "Game exited with code: $GAME_EXIT_CODE"
    return $GAME_EXIT_CODE
}

# Main
main() {
    clear
    echo "=========================================="
    echo "  $GAME_NAME"
    echo "  UMU Launcher v1.0"
    echo "=========================================="
    echo ""
    
    validate
    setup_environment
    launch_game
}

main "$@"
